---
- name: "Deploy Multi Cluster OCP Components"
  hosts: localhost
  gather_facts: false
  vars_files:
    - "vars.yml"
    - "secrets/secrets.yml" # Not saved to repo - see secrets.yml.example for requirements
  collections:
    - custom_aws.ec2
  tasks:
    - name: Initialize VPC
      register: res_vpcs
      loop: "{{ vpcs }}"
      amazon.aws.ec2_vpc_net:
        name: "{{ item.name }}"
        cidr_block: "{{ item.cidr }}"
        region: "{{ primary_region }}"
        tenancy: default
        # Explicit Defaults
        dns_support: true
        dns_hostnames: true
        multi_ok: false

    - name: "Initialize A VPC Internet Gateway in vpcs[0] - ({{ vpcs[0].name }})"
      register: res_igw_tor
      amazon.aws.ec2_vpc_igw:
        vpc_id: "{{ res_vpcs.results[0].vpc.id }}" # NOTE: hard coded 0 - watch ordering on "vpcs" variable
        tags:
          Name: "tor-igw"

    - name: "Initialize A VPC Internet Gateway in vpcs[1] - ({{ vpcs[1].name }})"
      register: res_igw_alpha
      amazon.aws.ec2_vpc_igw:
        vpc_id: "{{ res_vpcs.results[1].vpc.id }}" # NOTE: hard coded 1 - watch ordering on "vpcs" variable
        tags:
          Name: "alpha-igw"

    - name: "Initialize A VPC Internet Gateway in vpcs[2] - ({{ vpcs[2].name }})"
      register: res_igw_beta
      amazon.aws.ec2_vpc_igw:
        vpc_id: "{{ res_vpcs.results[2].vpc.id }}" # NOTE: hard coded 2 - watch ordering on "vpcs" variable
        tags:
          Name: "beta-igw"

    # TODO: Optimize the three module calls into one

    - name: Initialize First VPC Subnets
      loop: "{{ vpcs[0].subnets }}"
      register: res_subnets_0
      amazon.aws.ec2_vpc_subnet:
        vpc_id: "{{ res_vpcs.results[0].vpc.id }}"
        az: "{{ item.az }}"
        cidr: "{{ item.cidr }}"
        purge_tags: false
        tags:
          Name: "{{ item.name }}"

    - name: Initialize Second VPC Subnets
      loop: "{{ vpcs[1].subnets }}"
      register: res_subnets_1
      amazon.aws.ec2_vpc_subnet:
        vpc_id: "{{ res_vpcs.results[1].vpc.id }}"
        az: "{{ item.az }}"
        cidr: "{{ item.cidr }}"
        purge_tags: false
        tags:
          Name: "{{ item.name }}"
          kubernetes.io/cluster/unmanaged: "{{ true if '-tgw-' in item.name else omit }}"

    - name: Initialize Third VPC Subnets
      loop: "{{ vpcs[2].subnets }}"
      register: res_subnets_2
      amazon.aws.ec2_vpc_subnet:
        vpc_id: "{{ res_vpcs.results[2].vpc.id }}"
        az: "{{ item.az }}"
        cidr: "{{ item.cidr }}"
        purge_tags: false
        tags:
          Name: "{{ item.name }}"
          kubernetes.io/cluster/unmanaged: "{{ true if '-tgw-' in item.name else omit }}"

    - name: "Get Tor Public Subnet IDs"
      loop: "{{ vpcs[0].subnets }}"
      when: "'-public-' in item.name"
      ansible.builtin.set_fact:
        tor_public_subnet_ids: "{{ tor_public_subnet_ids | default([]) + [(res_subnets_0['results'] | selectattr('subnet.tags.Name', 'equalto', item.name))[0]['subnet']['id']]
          }}"

    - name: "Get Private Subnet IDs"
      loop: "{{ vpcs[0].subnets }}"
      when: "'-private-' in item.name"
      ansible.builtin.set_fact:
        tor_private_subnet_ids: "{{ tor_private_subnet_ids | default([]) + [(res_subnets_0['results'] | selectattr('subnet.tags.Name', 'equalto', item.name))[0]['subnet']['id']]
          }}"

    - name: "Get TGW Subnet IDs"
      loop: "{{ vpcs[0].subnets }}"
      when: "'-tgw-' in item.name"
      ansible.builtin.set_fact:
        tor_tgw_subnet_ids: "{{ tor_tgw_subnet_ids | default([]) + [(res_subnets_0['results'] | selectattr('subnet.tags.Name', 'equalto', item.name))[0]['subnet']['id']]
          }}"

    - name: "Get Alpha Public Subnet IDs"
      loop: "{{ vpcs[1].subnets }}"
      when: "'-public-' in item.name"
      ansible.builtin.set_fact:
        alpha_public_subnet_ids: "{{ alpha_public_subnet_ids | default([]) + [(res_subnets_1['results'] | selectattr('subnet.tags.Name', 'equalto', item.name))[0]['subnet']['id']]
          }}"

    - name: "Get Alpha Private Subnet IDs"
      loop: "{{ vpcs[1].subnets }}"
      when: "'-private-' in item.name"
      ansible.builtin.set_fact:
        alpha_private_subnet_ids: "{{ alpha_private_subnet_ids | default([]) + [(res_subnets_1['results'] | selectattr('subnet.tags.Name', 'equalto', item.name))[0]['subnet']['id']]
          }}"

    - name: "Get Beta Public Subnet IDs"
      loop: "{{ vpcs[2].subnets }}"
      when: "'-public-' in item.name"
      ansible.builtin.set_fact:
        beta_public_subnet_ids: "{{ beta_public_subnet_ids | default([]) + [(res_subnets_2['results'] | selectattr('subnet.tags.Name', 'equalto', item.name))[0]['subnet']['id']]
          }}"

    - name: "Get Beta Private Subnet IDs"
      loop: "{{ vpcs[2].subnets }}"
      when: "'-private-' in item.name"
      ansible.builtin.set_fact:
        beta_private_subnet_ids: "{{ beta_private_subnet_ids | default([]) + [(res_subnets_2['results'] | selectattr('subnet.tags.Name', 'equalto', item.name))[0]['subnet']['id']]
          }}"

    # TODO: it would be nice if this could live in vars.yml since it is carving out ip space. struggling between the need for subnet ids and ips/names but I also need to reuse this after IPI to make the interfaces ...
    - name: "Establish Subnet CIDR Reservations Fact"
      ansible.builtin.set_fact:
        subnet_reservations:
        # tor
          - cluster: "tor"
            subnet_id: "{{ tor_private_subnet_ids[0] }}"
            cidr: "10.0.0.96/32"
            eni_name: "bgp-peer-tor-private-us-east-2a"
          - cluster: "tor"
            subnet_id: "{{ tor_private_subnet_ids[1] }}"
            cidr: "10.0.1.96/32"
            eni_name: "bgp-peer-tor-private-us-east-2b"
          - cluster: "tor"
            subnet_id: "{{ tor_private_subnet_ids[2] }}"
            cidr: "10.0.2.96/32"
            eni_name: "bgp-peer-tor-private-us-east-2c"
          # alpha
          - cluster: "alpha"
            subnet_id: "{{ alpha_private_subnet_ids[0] }}"
            cidr: "10.1.0.96/32"
            eni_name: "bgp-peer-alpha-private-us-east-2a"
          - cluster: "alpha"
            subnet_id: "{{ alpha_private_subnet_ids[1] }}"
            cidr: "10.1.32.96/32"
            eni_name: "bgp-peer-alpha-private-us-east-2b"
          - cluster: "alpha"
            subnet_id: "{{ alpha_private_subnet_ids[2] }}"
            cidr: "10.1.64.96/32"
            eni_name: "bgp-peer-alpha-private-us-east-2c"
          # beta
          - cluster: "beta"
            subnet_id: "{{ beta_private_subnet_ids[0] }}"
            cidr: "10.2.0.96/32"
            eni_name: "bgp-peer-beta-private-us-east-2a"
          - cluster: "beta"
            subnet_id: "{{ beta_private_subnet_ids[1] }}"
            cidr: "10.2.32.96/32"
            eni_name: "bgp-peer-beta-private-us-east-2b"
          - cluster: "beta"
            subnet_id: "{{ beta_private_subnet_ids[2] }}"
            cidr: "10.2.64.96/32"
            eni_name: "bgp-peer-beta-private-us-east-2c"

    # NOTE: A little duplication of get calls (same subnet gathered multiple times) saves effort on the create calls
    - name: "Get Subnet CIDR Reservations"
      register: res_reservations
      loop: "{{ subnet_reservations }}"
      changed_when: false
      ansible.builtin.command:
        cmd: "aws ec2 get-subnet-cidr-reservations --subnet-id {{ item.subnet_id }}"

    - name: "Create Subnets IPv4 Reservations"
      register: res_reservation
      loop: "{{ subnet_reservations }}"
      loop_control:
        index_var: i
      # When the cidr reservation isnt already part of the given subnet (note - doesnt check all subnets or the whole vpc)
      when: "(res_reservations.results[i].stdout | from_json).SubnetIpv4CidrReservations | selectattr('Cidr', 'equalto', item.cidr) | length == 0"
      changed_when: true # Only runs when a change is needed
      ansible.builtin.command:
        cmd: "aws ec2 create-subnet-cidr-reservation --cidr '{{ item.cidr }}' --reservation-type 'explicit' --subnet-id '{{ item.subnet_id }}'"
    
    - name: Initialize the Transit Gateway
      register: res_tgw
      amazon.aws.ec2_transit_gateway:
        description: Gateway between the alpha cluster, beta cluster, and internet
        region: "{{ primary_region }}"
        wait: true
        auto_associate: false
        auto_propagate: false
        # dns_support: true
        # multicast_support: false
        tags:
          Name: "tgw-tor-{{ primary_region }}"

    - name: Save the Transit Gateway ID
      ansible.builtin.set_fact:
        transit_gateway_id: "{{ res_tgw.transit_gateway.transit_gateway_id }}"

    - name: Compile the 'tgwa-tor' TGW Attachment Facts
      ansible.builtin.set_fact:
        tgwa_tor:
          name: tgwa-tor
          subnets: "{{ res_subnets_0.results | selectattr('subnet.tags.Name', 'search', '.*-tgw-.*') | map(attribute='subnet.id') }}"
          appliance_mode_support: true

    - name: Compile the 'tgwa-alpha' TGW Attachment Facts
      ansible.builtin.set_fact:
        tgwa_alpha:
          name: tgwa-alpha
          subnets: "{{ res_subnets_1.results | selectattr('subnet.tags.Name', 'search', '.*-tgw-.*') | map(attribute='subnet.id') }}"
          appliance_mode_support: false

    - name: Compile the 'tgwa-beta' TGW Attachment Facts
      ansible.builtin.set_fact:
        tgwa_beta:
          name: tgwa-beta
          subnets: "{{ res_subnets_2.results | selectattr('subnet.tags.Name', 'search', '.*-tgw-.*') | map(attribute='subnet.id') }}"
          appliance_mode_support: false

    - name: "Initialize Transit Gateway Route Table: tgw-rt-internal"
      vars:
        tgw_rt_name: "tgw-rt-internal"
        tgw_id: "{{ transit_gateway_id }}"
      ansible.builtin.include_role:
        name: custom_aws.ec2.transit_gateway_route_table

    - name: "Initialize Transit Gateway Route Table: tgw-rt-external"
      vars:
        tgw_rt_name: "tgw-rt-external"
        tgw_id: "{{ transit_gateway_id }}"
      ansible.builtin.include_role:
        name: custom_aws.ec2.transit_gateway_route_table

    - name: "Display Transit Gateway Route Table Facts"
      ansible.builtin.debug:
        var: custom_aws_ec2_transit_gateway_route_table

    - name: Display Transit Gateway Attachment Facts
      loop:
        - tgwa_tor
        - tgwa_alpha
        - tgwa_beta
      ansible.builtin.debug:
        var: "{{ item }}"

    - name: Initialize the Transit Gateway Attachments
      loop:
        - "{{ tgwa_tor }}"
        - "{{ tgwa_alpha }}"
        - "{{ tgwa_beta }}"
      register: res_tgwas
      amazon.aws.ec2_transit_gateway_vpc_attachment:
        name: "{{ item.name }}"
        transit_gateway: "{{ transit_gateway_id }}"
        appliance_mode_support: "{{ item.appliance_mode_support }}"
        # dns_support: true
        subnets: "{{ item.subnets }}"
        wait: true
        tags:
          Name: "{{ item.name }}"

    - name: "Compile the TGW Route Table and Attachment IDs"
      ansible.builtin.set_fact:
        tgw_rt_id_internal: "{{ custom_aws_ec2_transit_gateway_route_table['tgw-rt-internal'].tgw_rt_id }}"
        tgw_rt_id_external: "{{ custom_aws_ec2_transit_gateway_route_table['tgw-rt-external'].tgw_rt_id }}"
        tgwa_id_tor: "{{ (res_tgwas.results | selectattr('item.name', 'equalto', 'tgwa-tor') | map(attribute='attachments'))[0] | map(attribute='transit_gateway_attachment_id')
          | first }}"
        tgwa_id_alpha: "{{ (res_tgwas.results | selectattr('item.name', 'equalto', 'tgwa-alpha') | map(attribute='attachments'))[0] | map(attribute='transit_gateway_attachment_id')
          | first }}"
        tgwa_id_beta: "{{ (res_tgwas.results | selectattr('item.name', 'equalto', 'tgwa-beta') | map(attribute='attachments'))[0] | map(attribute='transit_gateway_attachment_id')
          | first }}"

    - name: Compile the TGW Route Table Propagations and Associations Facts
      ansible.builtin.set_fact:
        propagations:
          # internal - tor
          - tgw_rtb_id: "{{ tgw_rt_id_internal }}"
            tgw_attach_id: "{{ tgwa_id_tor }}"
          # external - tor/alpha/beta
          - tgw_rtb_id: "{{ tgw_rt_id_external }}"
            tgw_attach_id: "{{ tgwa_id_tor }}"
          - tgw_rtb_id: "{{ tgw_rt_id_external }}"
            tgw_attach_id: "{{ tgwa_id_alpha }}"
          - tgw_rtb_id: "{{ tgw_rt_id_external }}"
            tgw_attach_id: "{{ tgwa_id_beta }}"
        associations:
          # internal - alpha/beta
          - tgw_rtb_id: "{{ tgw_rt_id_internal }}"
            tgw_attach_id: "{{ tgwa_id_alpha }}"
          - tgw_rtb_id: "{{ tgw_rt_id_internal }}"
            tgw_attach_id: "{{ tgwa_id_beta }}"
          # external - tor
          - tgw_rtb_id: "{{ tgw_rt_id_external }}"
            tgw_attach_id: "{{ tgwa_id_tor }}"

    - name: Display the Transit Gateway Route Table Propagations Facts
      ansible.builtin.debug:
        var: propagations

    - name: Display the Transit Gateway Route Table Associations Facts
      ansible.builtin.debug:
        var: associations

    - name: Create Transit Gateway Route Table Association
      loop: "{{ associations }}"
      vars:
        tgw_rtb_id: "{{ item.tgw_rtb_id }}"
        tgw_attach_id: "{{ item.tgw_attach_id }}"
      ansible.builtin.include_role:
        name: custom_aws.ec2.transit_gateway_route_table_association

    - name: Create Transit Gateway Route Table Propagation
      loop: "{{ propagations }}"
      vars:
        tgw_rtb_id: "{{ item.tgw_rtb_id }}"
        tgw_attach_id: "{{ item.tgw_attach_id }}"
      ansible.builtin.include_role:
        name: custom_aws.ec2.transit_gateway_route_table_propagation

    - name: "Create Transit Gateway Route Table Static Route (tgw-rt-internal/tgwa_id_tor)"
      register: res_static
      failed_when: "res_static.rc != 0 and 'RouteAlreadyExists' not in res_static.stderr"
      changed_when: "'An error occurred (RouteAlreadyExists) when calling the CreateTransitGatewayRoute operation' not in res_static.stderr"
      ansible.builtin.command:
        cmd: |
          aws ec2 create-transit-gateway-route --transit-gateway-route-table-id '{{ tgw_rt_id_internal }}' --destination-cidr-block '0.0.0.0/0' --transit-gateway-attachment-id '{{ tgwa_id_tor }}'

    - name: "Create Transit Gateway Route Table Static Route (tgw-rt-external/tgwa_id_alpha)"
      register: res_static
      failed_when: "res_static.rc != 0 and 'RouteAlreadyExists' not in res_static.stderr"
      changed_when: "'An error occurred (RouteAlreadyExists) when calling the CreateTransitGatewayRoute operation' not in res_static.stderr"
      ansible.builtin.command:
        cmd: |
          aws ec2 create-transit-gateway-route --transit-gateway-route-table-id '{{ tgw_rt_id_external }}' --destination-cidr-block '{{ vpcs[1].cidr }}' --transit-gateway-attachment-id '{{ tgwa_id_alpha }}'

    - name: "Create Transit Gateway Route Table Static Route (tgw-rt-external/tgwa_id_beta)"
      register: res_static
      failed_when: "res_static.rc != 0 and 'RouteAlreadyExists' not in res_static.stderr"
      changed_when: "'An error occurred (RouteAlreadyExists) when calling the CreateTransitGatewayRoute operation' not in res_static.stderr"
      ansible.builtin.command:
        cmd: |
          aws ec2 create-transit-gateway-route --transit-gateway-route-table-id '{{ tgw_rt_id_external }}' --destination-cidr-block '{{ vpcs[2].cidr }}' --transit-gateway-attachment-id '{{ tgwa_id_beta }}'

    # Create a NAT Gateway for each availability zone
    # NOTE: AWS accounts are normally limited to 5 elastic ip addresses
    - name: Initialize VPC NAT Gateways (cluster a private subnets)
      loop: "{{ vpcs[0].subnets }}" # NOTE: hard coded 0 for tor vpc - watch order in vpcs
      when: "'subnet-tor-public-' in item.name"
      register: res_ngws
      amazon.aws.ec2_vpc_nat_gateway:
        connectivity_type: "public"
        subnet_id: "{{ (res_subnets_0['results'] | selectattr('subnet.tags.Name', 'equalto', item.name))[0]['subnet']['id'] }}"
        if_exist_do_not_create: true
        wait: true
        tags:
          Name: "{{ item.name | regex_replace('subnet-', 'ngw-') }}"

    - name: Name the Elastic IPs
      loop: "{{ res_ngws['results'] }}"
      when: "item['nat_gateway_addresses'][0]['public_ip'] is defined"
      amazon.aws.ec2_eip:
        public_ip: "{{ item['nat_gateway_addresses'][0]['public_ip'] }}"
        tags:
          Name: "{{ item['item']['name'] | regex_replace('subnet-', 'eip-') }}"

    - name: "Create a Fact for Nat Gateway IDs"
      ansible.builtin.set_fact:
        ngw_ids: "{{ res_ngws.results | selectattr('nat_gateway_id', 'defined') | map(attribute='nat_gateway_id') }}"

    - name: Initialize VPC Route Tables (tor-public)
      register: res_rtb_tor_public
      amazon.aws.ec2_vpc_route_table:
        vpc_id: "{{ res_vpcs.results[0].vpc.id }}"
        subnets: "{{ tor_public_subnet_ids }}"
        routes:
          - dest: 0.0.0.0/0
            gateway_id: "{{ res_igw_tor.gateway_id }}"
          - dest: 10.1.0.0/16
            gateway_id: "{{ res_tgw.transit_gateway.transit_gateway_id }}"
          - dest: 10.2.0.0/16
            gateway_id: "{{ res_tgw.transit_gateway.transit_gateway_id }}"
        tags:
          Name: "tor-public"

    - name: Initialize VPC Route Tables (tor-private-{a,b,c})
      register: res_rtb_tor_private
      # NOTE: Nasty hardcoding - based on all previous ordering, 0=1, 1=b, 2=c for subnets and NGW
      loop:
        - index: 0
          letter: a
        - index: 1
          letter: b
        - index: 2
          letter: c
      amazon.aws.ec2_vpc_route_table:
        vpc_id: "{{ res_vpcs.results[0].vpc.id }}" # NOTE: 0 = tor
        subnets: "{{ [tor_private_subnet_ids[item.index]] + [tor_tgw_subnet_ids[item.index]] }}"
        routes:
          - dest: 0.0.0.0/0
            gateway_id: "{{ ngw_ids[item.index] }}"
        tags:
          Name: "tor-private-{{ item.letter }}"

    - name: Display Route Table Subnets (alpha)
      ansible.builtin.debug:
        var: alpha_private_subnet_ids

    - name: Initialize VPC Route Tables (alpha-public)
      register: res_rtb_alpha_public
      amazon.aws.ec2_vpc_route_table:
        vpc_id: "{{ res_vpcs.results[1].vpc.id }}"
        subnets: "{{ alpha_public_subnet_ids }}"
        routes:
          - dest: 0.0.0.0/0
            gateway_id: "{{ res_igw_alpha.gateway_id }}"
        tags:
          Name: "alpha-public"

    - name: Initialize VPC Route Tables (alpha-private)
      register: res_rtb_alpha_private
      amazon.aws.ec2_vpc_route_table:
        vpc_id: "{{ res_vpcs.results[1].vpc.id }}"
        subnets: "{{ alpha_private_subnet_ids }}"
        routes:
          - dest: 0.0.0.0/0
            gateway_id: "{{ res_tgw.transit_gateway.transit_gateway_id }}"
        tags:
          Name: "alpha-private"

    - name: Display Route Table Subnets (beta)
      ansible.builtin.debug:
        var: beta_private_subnet_ids

    - name: Initialize VPC Route Tables (beta-public)
      register: res_rtb_beta_public
      amazon.aws.ec2_vpc_route_table:
        vpc_id: "{{ res_vpcs.results[2].vpc.id }}"
        subnets: "{{ beta_public_subnet_ids }}"
        routes:
          - dest: 0.0.0.0/0
            gateway_id: "{{ res_igw_beta.gateway_id }}"
        tags:
          Name: "beta-public"

    - name: Initialize VPC Route Tables (beta-private)
      register: res_rtb_beta_private
      amazon.aws.ec2_vpc_route_table:
        vpc_id: "{{ res_vpcs.results[2].vpc.id }}"
        subnets: "{{ beta_private_subnet_ids }}"
        routes:
          - dest: 0.0.0.0/0
            gateway_id: "{{ res_tgw.transit_gateway.transit_gateway_id }}"
        tags:
          Name: "beta-private"

    - name: "Initialize VPC Endpoint (S3) - tor - {{ primary_region }}"
      amazon.aws.ec2_vpc_endpoint:
        region: "{{ primary_region }}"
        service: "com.amazonaws.{{ primary_region }}.s3"
        vpc_id: "{{ res_vpcs.results[0].vpc.id }}" # tor
        route_table_ids:
          - "{{ res_rtb_tor_public.route_table.id }}"
          - "{{ res_rtb_tor_private.results[0].route_table.id }}"
          - "{{ res_rtb_tor_private.results[1].route_table.id }}"
          - "{{ res_rtb_tor_private.results[2].route_table.id }}"

    - name: "Initialize VPC Endpoint (S3) - alpha - {{ primary_region }}"
      amazon.aws.ec2_vpc_endpoint:
        region: "{{ primary_region }}"
        service: "com.amazonaws.{{ primary_region }}.s3"
        vpc_id: "{{ res_vpcs.results[1].vpc.id }}" # alpha
        route_table_ids:
          - "{{ res_rtb_alpha_public.route_table.id }}"
          - "{{ res_rtb_alpha_private.route_table.id }}"

    - name: "Initialize VPC Endpoint (S3) - beta - {{ primary_region }}"
      amazon.aws.ec2_vpc_endpoint:
        region: "{{ primary_region }}"
        service: "com.amazonaws.{{ primary_region }}.s3"
        vpc_id: "{{ res_vpcs.results[2].vpc.id }}" # beta
        route_table_ids:
          - "{{ res_rtb_beta_public.route_table.id }}"
          - "{{ res_rtb_beta_private.route_table.id }}"

    - name: Initialize the public-facing-vms security group for each VPC
      register: sg_public_facing_vms
      loop:
        - 0
        - 1
        - 2
      amazon.aws.ec2_security_group:
        name: "public-facing-vms"
        description: "Public facing VMs that need SSH access"
        vpc_id: "{{ res_vpcs.results[item].vpc.id }}"
        rules:
          - proto: icmp
            icmp_code: -1 # All
            icmp_type: -1 # All
            cidr_ip: "{{ supernet_clusters }}"
          - proto: tcp
            ports:
              - 22
            cidr_ip: "0.0.0.0/0"
        tags:
          Name: "public-facing-vms"

    - name: Initialize the private-facing-vms security group
      register: sg_private_facing_vms
      loop:
        - "{{ res_vpcs.results[0].vpc.id }}"
        - "{{ res_vpcs.results[1].vpc.id }}"
        - "{{ res_vpcs.results[2].vpc.id }}"
      amazon.aws.ec2_security_group:
        name: "private-facing-vms"
        description: "Private facing VMs that need SSH access"
        vpc_id: "{{ item }}"
        rules:
          - proto: icmp
            icmp_code: -1 # All
            icmp_type: -1 # All
            cidr_ip: "{{ supernet_clusters }}"
          - proto: tcp
            ports:
              - 22
            cidr_ip: "{{ supernet_clusters }}"
        tags:
          Name: "private-facing-vms"

    - name: "Create install-config.yaml Files For Alpha, Beta"
      loop:
        - cluster: alpha
          supernet: "{{ supernet_alpha }}"
          subnets:
            - id: "{{ alpha_public_subnet_ids[0] }}"
            - id: "{{ alpha_public_subnet_ids[1] }}"
            - id: "{{ alpha_public_subnet_ids[2] }}"
            - id: "{{ alpha_private_subnet_ids[0] }}"
            - id: "{{ alpha_private_subnet_ids[1] }}"
            - id: "{{ alpha_private_subnet_ids[2] }}"
        - cluster: beta
          supernet: "{{ supernet_beta }}"
          subnets:
            - id: "{{ beta_public_subnet_ids[0] }}"
            - id: "{{ beta_public_subnet_ids[1] }}"
            - id: "{{ beta_public_subnet_ids[2] }}"
            - id: "{{ beta_private_subnet_ids[0] }}"
            - id: "{{ beta_private_subnet_ids[1] }}"
            - id: "{{ beta_private_subnet_ids[2] }}"
      vars:
        cluster: "{{ item.cluster }}"
        supernet: "{{ item.supernet }}"
        subnets: "{{ item.subnets }}"
      ansible.builtin.template:
        src: "install-config.yaml.j2"
        mode: "u=rw,g=r,o=r"
        dest: "ocp/{{ item.cluster }}.install-config.yaml"

    - name: "Save Generated Facts"
      ansible.builtin.copy:
        mode: "u=rw,g=r,o=r"
        dest: "generated_facts.yml"
        content: |
          ---
          # Facts generated during AWS bootstrapping
          res_vpcs: {{ res_vpcs }}
          tor_public_subnet_ids: {{ tor_public_subnet_ids }}
          tor_private_subnet_ids: {{ tor_private_subnet_ids }}
          tor_tgw_subnet_ids: {{ tor_tgw_subnet_ids }}
          alpha_public_subnet_ids: {{ alpha_public_subnet_ids }}
          alpha_private_subnet_ids: {{ alpha_private_subnet_ids }}
          beta_public_subnet_ids: {{ beta_public_subnet_ids }}
          beta_private_subnet_ids: {{ beta_private_subnet_ids }}
          subnet_reservations: {{ subnet_reservations }}
