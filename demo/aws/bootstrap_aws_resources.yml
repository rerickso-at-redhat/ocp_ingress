# yamllint disable rule:colons rule:line-length
---
- name: "Deploy BGP Router and BGP Interfaces"
  hosts: localhost
  gather_facts: false
  vars_files:
    - "vars.yml"
    - "{{ playbook_dir }}/ocp/{{ sandbox_domain }}/generated_facts.yml"
  tasks:
    - name: Initialize The Demo SSH Key
      amazon.aws.ec2_key:
        name: key-aws-demo
      register: res_key

    - name: Create The Demo SSH Key Locally
      when: "res_key.key.private_key is defined"
      ansible.builtin.copy:
        mode: "0600"
        content: "{{ res_key.key.private_key }}"
        dest: "secrets/key-aws-demo.pem"

    - name: Initialize Bastion EC2 Instance
      register: res_bastion
      amazon.aws.ec2_instance:
        name: "tor-bastion"
        key_name: "key-aws-demo"
        vpc_subnet_id: "{{ subnet_id_tor_public }}"
        instance_type: "t2.small"
        security_group: "public-facing-vms"
        image_id: "{{ ami_rhel_10 }}"
        network_interfaces:
          - assign_public_ip: true

    - name: "Create Security Group For BGP Ingress And Peering (tor-side)"
      amazon.aws.ec2_security_group:
        name: "tor-bgp-peering"
        description: "TOR-side BGP Peering"
        vpc_id: "{{ res_vpc.vpc.id }}"
        rules:
          - proto: icmp
            icmp_code: -1 # All
            icmp_type: -1 # All
            cidr_ip: "{{ supernet_clusters }}"
          - proto: tcp
            ports: 22
            cidr_ip: "{{ supernet_clusters }}"
          - proto: tcp
            ports: 443
            cidr_ip: "{{ supernet_tor }}"
          - proto: tcp
            ports: 80
            cidr_ip: "{{ supernet_tor }}"
          - proto: tcp
            ports: 179 # BGP
            cidr_ip: "{{ supernet_alpha }}"
          - proto: udp
            ports:
              - 3784 # BFD
              - 3785 # BFD
            cidr_ip: "{{ supernet_alpha }}"
          - proto: tcp
            ports: 179 # BGP
            cidr_ip: "{{ supernet_beta }}"
          - proto: udp
            ports:
              - 3784 # BFD
              - 3785 # BFD
            cidr_ip: "{{ supernet_beta }}"

    - name: "Get Security Groups"
      register: res_security_groups
      amazon.aws.ec2_security_group_info:

    # NOTE: Extremely permissive security group rules for lab purposes (moving bgp connections around easily w/o changing SGs)
    - name: "Edit Existing '-node-' Security Groups For BGP (tcp 179) and BFD (udp 3784/3785)"
      loop: "{{ res_security_groups.security_groups | selectattr('group_name', 'match', '.*-node') }}"
      amazon.aws.ec2_security_group:
        name: "{{ item.group_name }}"
        description: "{{ item.description }}"
        vpc_id: "{{ item.vpc_id }}"
        purge_rules: false
        purge_rules_egress: false
        purge_tags: false
        rules:
          - proto: icmp
            icmp_code: -1 # All
            icmp_type: -1 # All
            cidr_ip: "{{ supernet_clusters }}"
          - proto: tcp
            ports: 443
            cidr_ip: "{{ supernet_clusters }}"
          - proto: tcp
            ports: 80
            cidr_ip: "{{ supernet_clusters }}"
          - proto: tcp
            ports: 179
            cidr_ip: "{{ supernet_tor }}"
          - proto: udp
            ports:
              - 3784 # BFD
              - 3785 # BFD
            cidr_ip: "{{ supernet_tor }}"
          - proto: tcp
            ports: 179
            cidr_ip: "{{ supernet_alpha }}"
          - proto: udp
            ports:
              - 3784 # BFD
              - 3785 # BFD
            cidr_ip: "{{ supernet_alpha }}"
          - proto: tcp
            ports: 179
            cidr_ip: "{{ supernet_beta }}"
          - proto: udp
            ports:
              - 3784 # BFD
              - 3785 # BFD
            cidr_ip: "{{ supernet_beta }}"

    # NOTE: assumes a very specific formatting of the subnet_reservations variable passed from bootstrapping
    - name: "Create Network Interfaces For TOR Subnet IPv4 Reservations"
      register: res_enis
      loop: "{{ subnet_reservations }}"
      amazon.aws.ec2_eni:
        private_ip_address: "{{ item.cidr.split('/')[0] }}"
        subnet_id: "{{ item.subnet_id }}"
        # TOR gets the manually built security group only
        # Alpha gets the alpha node security group only
        # Beta gets the beta node security group only
        security_groups: "{{
          ['tor-bgp-peering'] if item.cluster == 'tor' else [] +
          [res_security_groups.security_groups | selectattr('group_name', 'match', item.cluster + '-.*-node') | map(attribute='group_name') | first] if item.cluster == 'alpha' else [] +
          [res_security_groups.security_groups | selectattr('group_name', 'match', item.cluster + '-.*-node') | map(attribute='group_name') | first] if item.cluster == 'beta' else []
        }}"
        tags:
          Name: "{{ item.eni_name }}"

    - name: Initialize the client ec2 instance
      register: ec2_client
      amazon.aws.ec2_instance:
        name: "tor-client"
        key_name: "key-aws-demo"
        vpc_subnet_id: "{{ subnet_id_tor_private }}"
        instance_type: "t2.small"
        image_id: "{{ ami_rhel_10 }}"
        security_group: "private-facing-vms"

    - name: "Get EC2 Instances"
      register: res_ec2_instances
      amazon.aws.ec2_instance_info:

    - name: "Get Worker Instances"
      ansible.builtin.set_fact:
        worker_instances: "{{ res_ec2_instances.instances | selectattr('tags.Name', 'match', '.*-worker-.*') }}"

    - name: Initialize the bgp-router ec2 instance
      register: ec2_router_bgp
      amazon.aws.ec2_instance:
        name: "tor-router-bgp"
        key_name: "key-aws-demo"
        vpc_subnet_id: "{{ subnet_id_tor_private }}"
        instance_type: "t2.medium"
        image_id: "{{ ami_rhel_10 }}"
        # NOTE: Aweful hard coded indices - 0-2 b/c "subnet_reservations" is 0-2 (tor, alpha, beta)
        network_interfaces_ids:
          # TOR AZ 1
          - id: "{{ res_enis.results[0].interface.id }}"
            device_index: 0
          # ALPHA AZ 1
          - id: "{{ res_enis.results[1].interface.id }}"
            device_index: 1
          # BETA AZ 1
          - id: "{{ res_enis.results[2].interface.id }}"
            device_index: 2

    - name: "Add Route 53 Entry For Bastion"
      amazon.aws.route53:
        state: present
        overwrite: true
        zone: "{{ sandbox_domain }}"
        type: "A"
        record: "bastion.{{ sandbox_domain }}"
        value:
          - "{{ res_bastion.instances[0].network_interfaces[0].public_ip_address | default(false) or res_bastion.instances[0].network_interfaces[0].association.public_ip }}"

    # TODO: the instances must be running to have a public IP available to add the host ...
    - name: "Add the Bastion AWS host to the Ansible Inventory"
      ansible.builtin.add_host:
        hostname: "tor-bastion"
        groups:
          - "bastion"
        ansible_ssh_host: "{{ res_bastion.instances[0].network_interfaces[0].public_dns_name | default(false) or res_bastion.instances[0].network_interfaces[0].association.public_dns_name }}"
        ansible_ssh_port: 22
        ansible_ssh_common_args: "-o StrictHostKeyChecking=false"
        ansible_user: "ec2-user"
        ansible_ssh_private_key_file: "secrets/key-aws-demo.pem"
        public_ip_address: "{{ res_bastion.instances[0].network_interfaces[0].public_ip_address | default(false) or res_bastion.instances[0].network_interfaces[0].association.public_ip }}"

    - name: "Add the Client AWS host to the Ansible Inventory"
      ansible.builtin.add_host:
        hostname: "tor-client"
        groups:
          - "client"
        ansible_ssh_host: "{{ ec2_client.instances[0].network_interfaces[0].private_dns_name | default(false) or ec2_client.instances[0].network_interfaces[0].association.private_dns_name }}"
        ansible_ssh_port: 22
        ansible_user: "ec2-user"
        ansible_ssh_private_key_file: "secrets/key-aws-demo.pem"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o ProxyCommand='ssh -i secrets/key-aws-demo.pem -p 22 -W %h:%p -o StrictHostKeyChecking=no -q ec2-user@{{ hostvars['tor-bastion']['ansible_ssh_host'] }}'"

    # TODO: copy the key over to the bastion
    - name: "Add the BGP AWS host to the Ansible Inventory"
      ansible.builtin.add_host:
        hostname: "tor-bgp-router"
        groups:
          - "bgp"
        ansible_ssh_host: "{{ vpc.dhcp_res_router_bgp_tor_private.split('/')[0] }}"
        ansible_ssh_port: 22
        ansible_host_key_checking: false
        ansible_user: "ec2-user"
        ansible_ssh_private_key_file: "secrets/key-aws-demo.pem"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o ProxyCommand='ssh -i secrets/key-aws-demo.pem -p 22 -W %h:%p -o StrictHostKeyChecking=no -q ec2-user@{{ hostvars['tor-bastion']['ansible_ssh_host'] }}'"
        aws_private_dns_name: "{{ (ec2_router_bgp.instances[0].network_interfaces | selectattr('private_ip_address', 'equalto', vpc.dhcp_res_router_bgp_tor_private.split('/')[0]))[0].private_dns_name }}"
        worker_instances: "{{ worker_instances }}" # For BGP Config
    # NOTE: maybe rsync content from the bastion to the test nodes

    - name: "Get EC2 Instances"
      register: res_ec2_instances
      amazon.aws.ec2_instance_info:

    - name: "Get Worker Instances"
      ansible.builtin.set_fact:
        router_instance: "{{ (res_ec2_instances.instances | selectattr('tags.Name', 'equalto', 'tor-router-bgp'))[0] }}"
        client_instance: "{{ (res_ec2_instances.instances | selectattr('tags.Name', 'equalto', 'tor-client'))[0] }}"

    # Each worker assumed to have one and only one interface (default IPI behavior)
    - name: "Disable 'source/destination checking' For Each Worker Node"
      loop: "{{ worker_instances | map(attribute='network_interfaces.0.network_interface_id') }}"
      changed_when: true # currently always runs
      ansible.builtin.command:
        cmd: |
          aws ec2 modify-network-interface-attribute --network-interface-id '{{ item }}' --source-dest-check '{"Value":false}'

    - name: "Disable 'source/destination checking' For Each Router and Client Interface"
      loop:
        - "{{ router_instance.network_interfaces[0].network_interface_id }}"
        - "{{ router_instance.network_interfaces[1].network_interface_id }}"
        - "{{ router_instance.network_interfaces[2].network_interface_id }}"
        - "{{ client_instance.network_interfaces[0].network_interface_id }}"
      changed_when: true # currently always runs
      ansible.builtin.command:
        cmd: |
          aws ec2 modify-network-interface-attribute --network-interface-id '{{ item }}' --source-dest-check '{"Value":false}'

- name: "Configure the BGP Router VM"
  hosts: bgp
  gather_facts: false
  vars_files:
    - "vars.yml"
  become: true
  handlers:
    - name: "Restart FRR"
      ansible.builtin.service:
        name: frr
        state: restarted
  tasks:
    - name: "Wait For SSH Connectivity"
      failed_when: false
      ansible.builtin.wait_for_connection:
        timeout: 90

    - name: "Wait For SSH Connectivity"
      failed_when: false
      ansible.builtin.wait_for_connection:
        timeout: 90

    - name: "Enable IP Forwarding"
      register: res_sysctl
      ansible.builtin.copy:
        owner: root
        group: root
        mode: "u=rw,g=r,o="
        dest: /etc/sysctl.d/999-forwarding.conf
        # Disabling RP Fitlers may or may not be needed depending on your system
        content: |
          net.ipv4.conf.all.forwarding=1
          net.ipv6.conf.all.forwarding=1
          net.ipv4.conf.all.rp_filter=1
          net.ipv4.conf.default.rp_filter=1
          net.ipv4.conf.lo.rp_filter=1
          net.ipv4.conf.enX0.rp_filter=1
          net.ipv4.conf.enX1.rp_filter=1
          net.ipv4.conf.enX2.rp_filter=1

    - name: "Initialize New sysctl Conf"
      changed_when: "res_sysctl.changed" # noqa: no-handler
      ansible.builtin.command:
        cmd: "sysctl -p /etc/sysctl.d/999-forwarding.conf"

    - name: "Install FRR"
      ansible.builtin.dnf:
        name: frr
        state: present

    - name: "Configure FRR Daemons - bgpd"
      notify:
        - "Restart FRR"
      ansible.builtin.lineinfile:
        path: /etc/frr/daemons
        search_string: "bgpd=no"
        line: "bgpd=yes"

    - name: "Configure FRR Daemons - bfdd"
      notify:
        - "Restart FRR"
      ansible.builtin.lineinfile:
        path: /etc/frr/daemons
        search_string: "bfdd=no"
        line: "bfdd=yes"

    # TODO: get prefix list addresses via var
    # yamllint disable rule:colons
    - name: "Configure FRR"
      notify:
        - "Restart FRR"
      vars:
        # Alpha
        first_neighbor_alpha_ip: "{{ (worker_instances | selectattr('tags.Name', 'match', 'alpha-.*-worker-us-east-2a-.*'))[0].network_interfaces[0].private_ip_address }}"
        first_neighbor_alpha_dns: "{{ (worker_instances | selectattr('tags.Name', 'match', 'alpha-.*-worker-us-east-2a-.*'))[0].network_interfaces[0].private_dns_name }}"
        second_neighbor_alpha_ip: "{{ (worker_instances | selectattr('tags.Name', 'match', 'alpha-.*-worker-us-east-2a-.*'))[1].network_interfaces[0].private_ip_address }}"
        second_neighbor_alpha_dns: "{{ (worker_instances | selectattr('tags.Name', 'match', 'alpha-.*-worker-us-east-2a-.*'))[1].network_interfaces[0].private_dns_name }}"
        third_neighbor_alpha_ip: "{{ (worker_instances | selectattr('tags.Name', 'match', 'alpha-.*-worker-us-east-2a-.*'))[2].network_interfaces[0].private_ip_address }}"
        third_neighbor_alpha_dns: "{{ (worker_instances | selectattr('tags.Name', 'match', 'alpha-.*-worker-us-east-2a-.*'))[2].network_interfaces[0].private_dns_name }}"
        # Beta
        first_neighbor_beta_ip: "{{ (worker_instances | selectattr('tags.Name', 'match', 'beta-.*-worker-us-east-2a-.*'))[0].network_interfaces[0].private_ip_address }}"
        first_neighbor_beta_dns: "{{ (worker_instances | selectattr('tags.Name', 'match', 'beta-.*-worker-us-east-2a-.*'))[0].network_interfaces[0].private_dns_name }}"
        second_neighbor_beta_ip: "{{ (worker_instances | selectattr('tags.Name', 'match', 'beta-.*-worker-us-east-2a-.*'))[1].network_interfaces[0].private_ip_address }}"
        second_neighbor_beta_dns: "{{ (worker_instances | selectattr('tags.Name', 'match', 'beta-.*-worker-us-east-2a-.*'))[1].network_interfaces[0].private_dns_name }}"
        third_neighbor_beta_ip: "{{ (worker_instances | selectattr('tags.Name', 'match', 'beta-.*-worker-us-east-2a-.*'))[2].network_interfaces[0].private_ip_address }}"
        third_neighbor_beta_dns: "{{ (worker_instances | selectattr('tags.Name', 'match', 'beta-.*-worker-us-east-2a-.*'))[2].network_interfaces[0].private_dns_name }}"
      ansible.builtin.copy:
        owner: frr
        group: frr
        mode: "u=rw,g=r,o="
        dest: /etc/frr/frr.conf
        content: |
          hostname {{ aws_private_dns_name }}
          ip prefix-list ACCEPT_CLUSTERS seq 5 permit {{ supernet_anycast }} le 32
          !
          router bgp 65000
           bgp router-id {{ vpc.dhcp_res_router_bgp_tor_private.split('/')[0] }}
           bgp bestpath as-path multipath-relax
           neighbor {{ first_neighbor_alpha_ip }} remote-as 65001
           neighbor {{ second_neighbor_alpha_ip }} remote-as 65001
           neighbor {{ third_neighbor_alpha_ip }} remote-as 65001
           neighbor {{ first_neighbor_beta_ip }} remote-as 65002
           neighbor {{ second_neighbor_beta_ip }} remote-as 65002
           neighbor {{ third_neighbor_beta_ip }} remote-as 65002
           address-family ipv4 unicast
            neighbor {{ first_neighbor_alpha_ip }} soft-reconfiguration inbound
            neighbor {{ first_neighbor_alpha_ip }} route-map ACCEPT_CLUSTERS in
            !
            neighbor {{ second_neighbor_alpha_ip }} soft-reconfiguration inbound
            neighbor {{ second_neighbor_alpha_ip }} route-map ACCEPT_CLUSTERS in
            !
            neighbor {{ third_neighbor_alpha_ip }} soft-reconfiguration inbound
            neighbor {{ third_neighbor_alpha_ip }} route-map ACCEPT_CLUSTERS in
            !
            neighbor {{ first_neighbor_beta_ip }} soft-reconfiguration inbound
            neighbor {{ first_neighbor_beta_ip }} route-map ACCEPT_CLUSTERS in
            !
            neighbor {{ second_neighbor_beta_ip }} soft-reconfiguration inbound
            neighbor {{ second_neighbor_beta_ip }} route-map ACCEPT_CLUSTERS in
            !
            neighbor {{ third_neighbor_beta_ip }} soft-reconfiguration inbound
            neighbor {{ third_neighbor_beta_ip }} route-map ACCEPT_CLUSTERS in
            !
            maximum-paths 4
           exit-address-family
          exit
          !
          route-map ACCEPT_CLUSTERS permit 10
           match ip address prefix-list ACCEPT_CLUSTERS
          exit

    - name: "Enable the FRR Service"
      ansible.builtin.service:
        name: frr
        enabled: true
        state: started

- name: "Configure the Client VM"
  hosts: client
  gather_facts: false
  vars_files:
    - "vars.yml"
  become: true
  tasks:
    - name: "Wait For SSH Connectivity"
      failed_when: false
      ansible.builtin.wait_for_connection:
        timeout: 90

    - name: "Wait For SSH Connectivity"
      failed_when: false
      ansible.builtin.wait_for_connection:
        timeout: 90

    - name: "Add Static Route For Anycast Via Router"
      register: res_route
      failed_when:
        - "res_route.rc != 0"
        - "'File exists' not in res_route.stderr"
      changed_when:
        - "res_route.rc == 0"
        - "'File exists' not in res_route.stderr"
      ansible.builtin.command:
        cmd: "ip route add {{ supernet_anycast }} via {{ vpc.dhcp_res_router_bgp_tor_private.split('/')[0] }}"
